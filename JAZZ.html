<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ImprovU AI Coach - JAZZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1"
      }
    }
    </script>
    <style>
      /* Simple keyframe animation for the loading dots */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .animate-pulse-dots span {
        animation: pulse 1.4s infinite ease-in-out both;
      }
      .animate-pulse-dots span:nth-child(1) { animation-delay: -0.32s; }
      .animate-pulse-dots span:nth-child(2) { animation-delay: -0.16s; }
    </style>
</head>
<body class="bg-gray-900 font-sans">
    <div id="app" class="flex flex-col h-screen text-white">
      <header class="p-4 bg-gray-800 border-b border-gray-700 shadow-lg">
        <h1 class="text-2xl font-bold text-center text-indigo-400">improvU AI Coach: JAZZ</h1>
        <p class="text-center text-gray-400">Learning "Yes, and..."</p>
      </header>

      <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
        <div id="messages-list" class="max-w-4xl mx-auto">
          <!-- Chat messages will be dynamically inserted here -->
        </div>
      </main>

      <footer class="p-4 bg-gray-800/80 backdrop-blur-sm border-t border-gray-700">
        <form id="chat-form" class="max-w-4xl mx-auto flex items-center gap-2">
          <input
            id="user-input"
            type="text"
            placeholder="Ask a question or send a message..."
            class="flex-1 w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-200 placeholder-gray-400 transition-shadow duration-200"
          />
          <button
            id="send-button"
            type="submit"
            class="p-3 bg-indigo-600 rounded-full text-white hover:bg-indigo-500 disabled:bg-gray-600 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-all duration-200 transform active:scale-95 disabled:scale-100"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
            </svg>
          </button>
        </form>
        <p id="error-message" class="text-red-400 text-center mt-2 text-sm"></p>
      </footer>
    </div>

    <script type="module">
      import { GoogleGenAI } from '@google/genai';

      const SYSTEM_INSTRUCTION = `You are JAZZ, an encouraging and playful improv coach from a web app called improvU.

**IMPORTANT RULES:**
- You MUST NOT use any markdown (like **bold** or *italics*).
- You MUST NOT use any emojis.
- All your responses MUST be short and concise (4-5 sentences maximum).
- When creating a list, you MUST use the round bullet character (•). Do NOT use asterisks (*) or hyphens (-). For example: • This is a correct list item.

**YOUR GOAL:**
Your one and only goal right now is to teach the user the 'Yes, and...' concept. Do not try to start the practice game, just teach the lesson.

**TEACHING FLOW:**
1. Your very first message must be a short welcome of 2-3 sentences. Introduce yourself as JAZZ from improvU and ask the user if they're ready to learn about the 'Yes, and...' concept. Do not explain anything else yet.
2. After the user confirms they are ready, explain the objective of 'Yes, and...'. Use a short introductory sentence, followed by a bulleted list (using •) to break down the key points.
3. Then, explain the rules of how to play. Again, use a short introductory sentence followed by a bulleted list (using •) to detail each rule clearly.
4. Patiently answer any questions the user has about the rules or objective. If they seem confused, try to re-explain in a simpler way.

Keep your tone encouraging, upbeat, and judgment-free.`;

      // --- DOM Elements ---
      const chatContainer = document.getElementById('chat-container');
      const messagesList = document.getElementById('messages-list');
      const chatForm = document.getElementById('chat-form');
      const userInput = document.getElementById('user-input');
      const sendButton = document.getElementById('send-button');
      const errorMessage = document.getElementById('error-message');

      let chatSession = null;
      let isLoading = false;

      // --- Core Functions ---
      function setElementDisabled(element, disabled) {
        element.disabled = disabled;
      }
      
      function renderLoadingIndicator() {
        const loadingHtml = `
          <div class="flex items-start gap-3 my-4 justify-start" id="loading-indicator">
              <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white flex-shrink-0">
                  J
              </div>
              <div class="max-w-md p-4 rounded-2xl bg-gray-700 text-gray-200 rounded-tl-none flex items-center gap-2 animate-pulse-dots">
                  <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                  <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                  <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
              </div>
          </div>`;
        messagesList.insertAdjacentHTML('beforeend', loadingHtml);
        scrollToBottom();
      }
      
      function removeLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
          indicator.remove();
        }
      }

      function appendMessage(role, text) {
        const isModel = role === 'model';
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex items-start gap-3 my-4 ${isModel ? 'justify-start' : 'justify-end'}`;

        let messageHtml = '';
        if (isModel) {
            messageHtml += `
            <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white flex-shrink-0">
              J
            </div>`;
        }
        messageHtml += `
          <div class="max-w-md lg:max-w-2xl p-4 rounded-2xl whitespace-pre-wrap h-fit ${
            isModel ? 'bg-gray-700 text-gray-200 rounded-tl-none' : 'bg-blue-600 text-white rounded-br-none'
          }">
            ${text}
          </div>`;
        
        messageWrapper.innerHTML = messageHtml;
        messagesList.appendChild(messageWrapper);
        scrollToBottom();
        return messageWrapper;
      }

      function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function setUIState(loading) {
        isLoading = loading;
        setElementDisabled(userInput, loading);
        // If loading, always disable the button. If not loading, disable based on input content.
        setElementDisabled(sendButton, loading || userInput.value.trim() === '');
        errorMessage.textContent = '';
      }

      async function handleSendMessage(messageText) {
        if (isLoading || !chatSession) return;
        setUIState(true);
        
        appendMessage('user', messageText);
        renderLoadingIndicator();

        try {
          const stream = await chatSession.sendMessageStream({ message: messageText });
          removeLoadingIndicator();
          
          let fullResponse = "";
          const modelMessageContainer = appendMessage('model', '');
          const modelTextElement = modelMessageContainer.querySelector('.whitespace-pre-wrap');

          for await (const chunk of stream) {
            fullResponse += chunk.text;
            modelTextElement.textContent = fullResponse;
            scrollToBottom();
          }
        } catch (e) {
          console.error("API Error:", e);
          const errorText = e instanceof Error ? e.message : "Failed to get a response from the AI.";
          errorMessage.textContent = `Oops! Something went wrong: ${errorText}`;
          removeLoadingIndicator();
        } finally {
          setUIState(false);
          userInput.focus();
        }
      }

      // --- Initialization ---
      async function initializeChat() {
        setUIState(true);
        renderLoadingIndicator();
        try {
          if (!process.env.API_KEY) {
            throw new Error("The process.env.API_KEY environment variable is not set. Please add an API key to the 'Secrets' panel.");
          }
          const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
          chatSession = ai.chats.create({
            model: 'gemini-2.5-flash',
            config: {
              systemInstruction: SYSTEM_INSTRUCTION,
            },
          });

          // Start the conversation
          const stream = await chatSession.sendMessageStream({ message: "Hello!" });
          removeLoadingIndicator();

          let fullResponse = "";
          const modelMessageContainer = appendMessage('model', '');
          const modelTextElement = modelMessageContainer.querySelector('.whitespace-pre-wrap');

          for await (const chunk of stream) {
            fullResponse += chunk.text;
            modelTextElement.textContent = fullResponse;
            scrollToBottom();
          }
        } catch (e) {
          console.error("Initialization Error:", e);
          errorMessage.textContent = e instanceof Error ? e.message : "An unknown error occurred during initialization.";
          removeLoadingIndicator();
        } finally {
          setUIState(false);
          userInput.focus();
        }
      }
      
      // --- Event Listeners ---
      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const messageText = userInput.value.trim();
        if (messageText) {
          handleSendMessage(messageText);
          userInput.value = '';
          sendButton.disabled = true; // Disable button after sending
        }
      });
      
      userInput.addEventListener('input', () => {
          if (!isLoading) {
              sendButton.disabled = userInput.value.trim() === '';
          }
      });

      // --- Start the App ---
      document.addEventListener('DOMContentLoaded', () => {
        sendButton.disabled = true; // Disable button on initial load
        initializeChat();
      });
    </script>
</body>
</html>